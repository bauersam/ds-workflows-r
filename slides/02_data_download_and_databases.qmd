---
execute: 
  eval: true
---

## Raw Data Retrieval and {.title-slide-light}
<h2>Working with Databases</h2>
![](https://httr2.r-lib.org/logo.png){.absolute top="200" left="50" width="260"} ![](slide_resources/db.png){.absolute top="200" left="310" width="260"}

## Section Agenda {.brackets-dark-teal}

-   Downloading data from sources
-   Writing production data to a database
-   Introduction to alerting 
-   Automating the pipeline

## Project Overview {.minimal}


![](slide_resources/workflow_diagram.jpg){fig-align="center"}


## Download raw data from an API endpoint

Your first instinct for retrieving raw data may be to download the data as a csv file. 
<br><br>

:::{.fragment}
ðŸ’¡ There's a better way!
:::

:::{.incremental}
- Many data sources offer an API endpoint for downloading data 
- `{httr2}` provides wrapper functions around `curl` requests for easier querying and handling of responses
:::

:::{.fragment}
{{< bi sign-turn-right-fill color=orange >}} `{httr2}` is a ground-up rewrite of `{httr}` that is pipeable! It implements an explicit `request` object that solves common problems such as built-in rate-limiting, retries, OAuth, secure secrets, and more.

:::

## Example `httr2` request

Here's how we will query the `vesselverbose` endpoint at

`https://www.wsdot.wa.gov/ferries/api/vessels/rest/vesselverbose?apiaccesscode={WSDOT_ACCESS_CODE}`

```{r}
#| eval: false
#| code-line-numbers: "1-2|4-7|9-11|13-17"
base_url <- "https://www.wsdot.wa.gov"
endpoint <- "ferries/api/vessels/rest/vesselverbose"

# Compose the API request 
req <- request(base_url) |> 
  req_url_path_append(endpoint) |> 
  req_url_query(apiaccesscode = Sys.getenv("WSDOT_ACCESS_CODE")) 
  
# perform the request
response <- req |> 
  req_perform()

# convert the body of the response to a tibble
response_body <- response |> 
  resp_body_string() |> 
  jsonlite::fromJSON() |> 
  as_tibble()
```
## 

:::{.center}
<h2> <br>**Activity Time!**</h2>
:::

:::{.callout-note icon=false}
## Activity
ðŸ‘‰ Open the project `materials/01-raw-data-write/01-raw-data-write.Rproj`

Activity objective: Download the `vesselverbose` data from the WSDOT API endpoint.

ðŸ›‘ Work through **Task 1 - Task 3** only. 

:::

## Where should I put the data?

:::{.fragment .middle .r-fit-text}
ðŸ“£ Production data belongs in a database.
:::

## Database Connection Essentials

::::{.smaller}
:::{.incremental}
- Use `{DBI}` to make a connection with `DBI::dbConnect()`
- The first argument to `{DBI}` is your DBI-compliant R package
:::

::: {.columns}
::: {.column .fragment}
[**Best case:**]{.positgreen} one of the DBI-compliant db-specific packages

![](slide_resources/con_sans_odbc.png){.absolute bottom="180" left="30" width="47%" }

:::
::: {.column .fragment}
[**Alternative:**]{.posityellow} `odbc::odbc()` + an ODBC driver installed on your system
![](slide_resources/con_w_odbc.png){.absolute bottom="180" right="30" width="47%" }

:::
::: 

:::{.fragment .absolute bottom="30"}
ðŸ“£ When possible, use a database-specific R package (e.g., `RPostgres`, `RMariaDB`, `RSQLite`, `bigrquery`, etc.) instead of `odbc` + a driver. In many cases, they are more performant (especially in writing data) and may have more translations available for query types.
:::

::::

## Interacting with Databases

:::{.incremental}

- What tables are in a database? `DBI::dbListTables(con)`
- Use `dplyr` to interact with the database table in the same manner you would a local data frame
  ```{.r code-line-numbers=false}
  df <- dplyr::tbl(con, "my_table")
  df |> filter(...) |> mutate(...) |> group_by(...) |> summarise(...)
  
  ```
- ðŸ“£ Do as much work as possible in the database to save time and resources before bringing the table into local memory. 
- Use `dplyr::collect()` to bring the table into memory. Try to use `collect` as late as possible in your queries / transformations

  ```{.r code-line-numbers=false}
  df |> ... |> collect()
  
  ```

:::

## More on databases {.content-light}

:::{.callout-tip icon=false}
## {{< bi sign-turn-right-fill color=orange >}} Best practices in working with databases

<https://solutions.posit.co/connections/db/> 


Specific resources:

::::{columns}

:::{.column width=40%}
- [Connect to a database](https://solutions.posit.co/connections/db/getting-started/connect-to-database/)
- [Query a database table](https://solutions.posit.co/connections/db/getting-started/database-queries/)
:::

:::{.column width=60%}

- [Securing credentials](https://solutions.posit.co/connections/db/best-practices/managing-credentials/)
- [Making scripts portable](https://solutions.posit.co/connections/db/best-practices/portable-code/)
:::
::::

:::

## 

:::{.center}
<h2> <br>**Activity Time!**</h2>
:::

:::{.callout-note icon=false}
## Activity
ðŸ‘‰ Return to the project `materials/01-raw-data-write/01-raw-data-write.Rproj`

Activity objective: Write the `vesselverbose` data to the database.

ðŸ›‘ Work through **Task 4 - Task 5** only. 

:::

## A brief {{< bi sign-turn-right-fill color=orange >}} on managing environments

ðŸ§° `{config}` can help you manage your development, test, and production environments without modifying your code

::: {.columns}
::: {.column}

```{.yaml filename="config.yml"}
default:
  dataset: "data_development.csv"

rsconnect:
  dataset: "data.csv"
```

:::
::: {.column}

```{.r filename="my_file.qmd"}
read_csv(config::get("dataset"))
```
:::
::: 

ðŸ§° Similarly, update environment variables to change behavior in development and production 
```{.r}
if (Sys.getenv("TEST_MODE") == TRUE){
  override_some_variable_for_testing <- TRUE} 
```

## How do I automate this process?

:::{.fragment}
ðŸ§° Deploy and schedule your ETL and reports on Posit Connect
<br>

![](slide_resources/scheduling.png){height="700" fig-align="center"}

:::

## Introduction to Emailing with Posit Connect

Posit Connect can send an email when a report or notebook renders

:::::{.columns}


:::{.column width=25%}
::::{.fragment}
![](slide_resources/email_option.png){height=700 style="padding-left: 25px;"}
::::
:::


:::{.column width=18% .fragment}


[{{< bi arrow-right >}}]{.largest .middle}
:::

:::{.column width=50%}

::::{.fragment}

![](slide_resources/html_email.png){style="padding-top: 50px;"}

::::

:::


:::::


::: {.fragment .absolute style="background: #F5EF94; width: 600px; height: 400px; padding: 30px; box-shadow: 0 18px 18px -9px lightgray; margin-left: auto; margin-right: auto;" top="350" right="220"}

[ðŸš«]{.larger}


ðŸ¥± This email is non-informative

ðŸ”Š Creates noise in the inbox

ðŸ™ˆ Does not compel anyone to look at it
:::






## Introduction to Emailing with ![](slide_resources/quarto-logo-trademark.svg){width=350 style="vertical-align:middle"} and Connect

Posit Connect can send (or suppress) custom Quarto-generated emails when a report or notebook renders


:::{.columns}

:::{.column width=25%}
![](slide_resources/email_option.png){height=700 style="padding-left: 25px;"}
:::

:::{.column width=10%}
[+]{.largest .middle}
:::


:::{.column width=25%}
![](slide_resources/qmd_email.png){.middle width=370}
:::

:::{.column width=10%}
[=]{.largest .middle}
:::

:::{.column width=30%}

[ðŸ§° Customized, conditional emails]{.large .middle}

:::

:::

## A Basic Quarto Email with [Conditional Send]{.positburg}

One Quarto document produces the rendered report and an [optional]{.positburg} email âœ¨

![](slide_resources/quarto_email_intro.png){fig-align="right"}



:::{.absolute bottom="20" left="20" width="900" .smaller}

ðŸ§° Include a conditional value that expresses `TRUE`|`FALSE` within a div called `::: {email-scheduled}` to send or suppress the email.

:::


## 

:::{.center}
<h2> <br>**Activity Time!**</h2>
:::

:::{.callout-note icon=false}



## Activity
ðŸ‘‰ Return to the project `materials/01-raw-data-write/01-raw-data-write.Rproj`

Activity objective: deploy and schedule this work on Posit Connect so it runs automatically and sends an email only if there's something amiss with the raw data.

ðŸ›‘ Work **Task 6 to the end of the document**. 

:::





